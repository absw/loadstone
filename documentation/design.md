Design documentation contains inline
[mermaid](https://mermaid-js.github.io/mermaid/#/) blocks. Install the [mermaid
browser extension](https://github.com/BackMarket/github-mermaid-extension) if
you want to view them directly on Github, or paste them on the Mermaid Live
Editor.

# Global Context (C1-1)

```mermaid
graph LR
   Chip--defines-->Port
   App[Builder App]--configures-->Port

   Port--constructs-->Bootloader

   Bootloader--boots-->Application
   Bootloader--updates-->Application
   Bootloader-.maybe recovers.->Application
   Bootloader--manages-->Images

   Application--selected from-->Images[Firmware Images]
```

# Bootloader (C2-1)

```mermaid
graph TB
   Bootloader-.may communicate via.->Serial
   Bootloader--manages-->ImgReader[Image Reader]
   Bootloader--drives-->McuFlash[Mcu Flash]
   Bootloader-.may drive.->ExternalFlash[External Flash]
   Bootloader==runs==>Application
   Bootloader--measures and relays-->BootMetrics[Boot Metrics]

   Serial-.may recover.->Application

   McuFlash--stores-->Fw[Firmware Images]
   ExternalFlash--stores-->Fw[(Firmware Images)]
   ImgReader--Verifies-->Fw

   Fw--updates-->Application
   Fw--restores-->Application

   Application-.may read.->BootMetrics

```

# Codegen Port (C2-2)
```mermaid
flowchart TB
   App[Builder Web App]-.generates.->Config
   Config[Configuration File]
   Script[Build Script]--reads-->Config
   Script--emits-->Autogenerated[Auto-generated Rust code]

   Port--includes-->Autogenerated
   Port--initializes-->Drivers
   subgraph Drivers
      direction LR
      Mcu[Mcu Flash]
      External[External Flash]
      Serial
      Timers
      style External stroke-dasharray: 5 5
      style Serial stroke-dasharray: 5 5
   end
   Port==constructs==>Bootloader
   Drivers--compose-->Bootloader

```
