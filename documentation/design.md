Design documentation contains inline
[mermaid](https://mermaid-js.github.io/mermaid/#/) blocks. Install the [mermaid
browser extension](https://github.com/BackMarket/github-mermaid-extension) if
you want to view them directly on Github, or paste them on the Mermaid Live
Editor.

# Global Context (C1-1)

```mermaid
graph LR
   Chip--defines-->Port
   App[Builder App]--configures-->Port

   Port--constructs-->Bootloader[Loadstone Bootloader]
   style Bootloader stroke-width:5px

   Bootloader==boots==>Application
   Bootloader--updates-->Application
   Bootloader-.maybe recovers.->Application
   Bootloader--manages-->Images

   Application--selected from-->Images[Firmware Images]
```

# Bootloader (C2-1)

```mermaid
graph TB
   Bootloader-.may communicate via.->Serial
   Bootloader--manages-->ImgReader[Image Reader]
   Bootloader--drives-->McuFlash[Mcu Flash]
   Bootloader-.may drive.->ExternalFlash[External Flash]
   Bootloader==runs==>Application
   Bootloader--measures and relays-->BootMetrics[Boot Metrics]
   style Bootloader stroke-width:5px

   Serial-.may recover.->Application

   McuFlash--stores-->Fw[Firmware Images]
   ExternalFlash--stores-->Fw[(Firmware Images)]
   ImgReader--Verifies-->Fw

   Fw--updates-->Application
   Fw--restores-->Application

   Application-.may read.->BootMetrics

```

# Codegen Port (C2-2)
```mermaid
flowchart
   App[Builder Web App]-.generates.->Config
   Config[Configuration File]
   Script[Build Script]--reads-->Config
   Script--emits-->Autogenerated[Auto-generated Rust code]

   style Port stroke-width:5px
   Port--includes-->Autogenerated
   Port--initializes-->Drivers
   subgraph Drivers
      subgraph Mandatory
         Mcu[Mcu Flash]
      end
      subgraph Optional
         External[External Flash]
         Serial
         Timers
         style External stroke-dasharray: 5 5
         style Serial stroke-dasharray: 5 5
         style Timers stroke-dasharray: 5 5
      end
   end
   Port==constructs==>Bootloader
   Drivers--compose-->Bootloader
```

# Builder App (C2-3)
```mermaid
flowchart
   App[Builder Web App]--rendered via-->EGUI
   style App stroke-width:5px
   User--interacts with-->Menus
   subgraph Menus
      Memory
      Security
      Features
   end
   App--displays-->Menus
   Menus--define-->Configuration
   Configuration--serializes into-->File[.ron configuration file]
   File-->Web{Running\n as Web app?}
   Web--yes-->Trigger[Trigger build in Github Actions]
   Web--yes-->Download[Download .ron file for local builds]
   Web--no-->Local[Save .ron file locally]
```
